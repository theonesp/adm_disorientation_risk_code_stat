---
title: "Survival Analysis"
output:
  html_notebook:
    toc: yes
---

# Enviroment 

```{r}
library(survival)
library(dplyr)
library(Deducer)
library(readxl)
library(ggplot2)
library(survminer)
library(jtools)
library(simPH)
```

# Loading our dataset

```{r}
main_df <- 
```


# Kaplan-Meier

Need Kaplan meir, grouped by disorientation. Outcome is time to event.  Censor code provided (censor =0, not 1). 

## Fitting survival data

```{r}
options(scipen=999)
# Fit survival data using the Kaplan-Meier method
surv_object <- Surv(time = round(main_df$time_to_event,2), event = main_df$code_descalation==0)
fit1 <- survfit(surv_object ~ disorientation
                , data = main_df)
```

## Summary of the survival fitted object

```{r}
surv_summary(fit1)
```


## Survival plot

```{r message=FALSE, warning=FALSE}
ggsurvplot(fit1, data = main_df, pval = TRUE)
```


## Hazard ration plot per confounder

```{r fig.height=10, fig.width=10}
# Fit a Cox proportional hazards model
fit.coxph <- coxph(surv_object ~ 
          patientage + patientgender+ ethnicity + unittype + apachedxgroup + apache_score + disorientation 
          ,data = main_df)
ggforest(fit.coxph, data = main_df)
```





# Cox proportional hazard model general

## Fitting survival data

Need cox survival. Provide Hazard raio and 95%CI. 
 - Outcome is time to event.  Censor code provided (censor =0, not 1).   
 - Variables: age, gender, ethnicity, icu type, diagnosis, apache score, and disorientation

```{r}
coxph <- coxph( Surv(time_to_event ,code_descalation==0) ~ 
                  patientage 
                + patientgender 
                + ethnicity 
                + unittype 
                + apachedxgroup 
                + apachescore 
                + disorientation 
                , method="breslow"
                ,data=main_df
                )
```

## Summary of the survival fitted object

```{r}
summary(coxph)
```
## Survival plot

```{r}
ggsurvplot(survfit(coxph), data = main_df, pval = TRUE)
```


## Odds ratio per variable

```{r}
oddsratios_table<-exp(cbind(coef(coxph), confint(coxph)))  
options(scipen=999)
oddsratios_table<-round(oddsratios_table,4)

oddsratios_table<-as.data.frame(oddsratios_table)
colnames(oddsratios_table)[1]<-"OR"

oddsratios_table<-oddsratios_table[order(row.names(oddsratios_table)), ]
boxLabels<-rownames(oddsratios_table)
oddsratios_table
```

# Cox proportional hazard model per Apache quartile

## Fitting survival data

```{r}
coxph_apache_q <-coxph( 
                   Surv(time_to_event, code_descalation==0) 
                     ~ patientage 
                     + patientgender 
                     + ethnicity 
                     + unittype 
                     + apachedxgroup 
                     + disorientation 
                     + strata(apache_quartiles)
                     ,data=main_df
                     )
```


## Summary of the survival fitted object

```{r}
summary(coxph_apache_q)
```

## Survival plot 

```{r}
ggfitStrata(survfit(coxph_apache_q), byStrata = TRUE,title = 'Apache Quartiles\nSurvival curves ')
```



